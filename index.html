<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0078d4" />
    <title>Portail École</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #fff;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Desktop Windows 11 Style */
        @media (min-width: 1025px) {
            .app-container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: #f3f3f3;
                border: 1px solid #d0d0d0;
                border-radius: 4px;
                box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.08);
                max-width: 1200px;
                margin: 8px auto;
            }

            .titlebar {
                background: linear-gradient(to bottom, #e8e8e8, #d4d4d4);
                border-bottom: 1px solid #b0b0b0;
                padding: 4px;
                display: flex;
                align-items: center;
                gap: 4px;
                height: 32px;
                flex-shrink: 0;
            }

            .titlebar-icon {
                width: 24px;
                height: 24px;
                padding: 2px;
                color: #000;
            }

            .titlebar-text {
                flex: 1;
                font-size: 13px;
                font-weight: 500;
                color: #000;
                text-align: center;
                user-select: none;
            }

            .window-button {
                width: 36px;
                height: 28px;
                border: 1px solid transparent;
                background: 0;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #000;
                font-size: 16px;
                transition: all 0.1s;
            }

            .window-button:hover:not(.close) {
                background: #e8e8e8;
                border: 1px solid #d0d0d0;
            }

            .window-button.close:hover {
                background: #e81123;
                color: white;
            }

            .content-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: white;
            }
        }

        /* Mobile Style */
        @media (max-width: 1024px) {
            .app-container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: white;
            }

            .titlebar {
                display: none;
            }

            .content-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
        }

        .win-button {
            background: #e8e8e8;
            border: 1px solid #d0d0d0;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #000;
            transition: all 0.1s;
        }

        .win-button:hover {
            background: #d8d8d8;
            border-color: #b0b0b0;
        }

        .win-button-primary {
            background: linear-gradient(to bottom, #0078d4, #005a9e);
            color: white;
            border: 1px solid #094db8;
            padding: 8px 16px;
            font-size: 13px;
        }

        .win-button-primary:hover {
            background: linear-gradient(to bottom, #1084d7, #0063b1);
        }

        .win-input {
            background: #fff;
            border: 1px solid #d0d0d0;
            padding: 8px 10px;
            border-radius: 2px;
            font-size: 13px;
            transition: all 0.1s;
            width: 100%;
            box-sizing: border-box;
        }

        .win-input:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.5);
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 2px;
            font-size: 12px;
            color: #666;
        }

        .sync-indicator.syncing {
            background: #e8f4f8;
            color: #0078d4;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .sync-dot.active {
            background: #0078d4;
            animation: pulse 1s infinite;
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body x-data="schoolApp()" x-init="initApp()">
    <div class="app-container" :style="isMinimized ? 'height: 32px; max-height: 32px;' : ''">
        <div class="titlebar" @mousedown="startDrag">
            <div class="titlebar-icon">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 21V5c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
            </div>
            <div class="titlebar-text">Portail École - Inspection de l'Éducation</div>
            <div style="display: flex; gap: 2px;">
                <button @click="isMinimized = !isMinimized" class="window-btn" style="width:36px; height:28px; border:1px solid transparent; background:0; cursor:pointer; display:flex; align-items:center; justify-content:center;">_</button>
                <button @click="isMaximized = !isMaximized" class="window-btn" style="width:36px; height:28px; border:1px solid transparent; background:0; cursor:pointer; display:flex; align-items:center; justify-content:center;" x-text="isMaximized ? '❐' : '☐'"></button>
                <button @click="logout()" class="window-btn" style="width:36px; height:28px; border:1px solid transparent; background:0; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#000;" onmouseover="this.style.background='#e81123'; this.style.color='white';" onmouseout="this.style.background='0'; this.style.color='#000';">✕</button>
            </div>
        </div>

        <div class="content-wrapper">
            <div x-show="school" class="border-b border-gray-300 bg-gray-50 p-4" style="flex-shrink: 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(to bottom right, #0078d4, #005a9e); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px;">
                            <span x-text="school.name.charAt(0)"></span>
                        </div>
                        <div>
                            <h1 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;" x-text="school.name"></h1>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #666;" x-text="`${school.access_code} • ${school.matricule}`"></p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div :class="`sync-indicator ${isSyncing ? 'syncing' : ''}`">
                            <div class="sync-dot" :class="{ active: isSyncing }"></div>
                            <span x-text="isSyncing ? '⟳ Sync' : isOnline ? '✓ En ligne' : '✕ Hors ligne'"></span>
                        </div>
                        <button @click="logout()" class="win-button" style="font-size: 12px; padding: 6px 12px;">Déco</button>
                    </div>
                </div>
            </div>

            <div x-show="!school" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                <div style="background: white; border: 1px solid #ccc; border-radius: 4px; padding: 24px; width: 100%; max-width: 400px;">
                    <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0 0 8px 0;">Portail École</h2>
                    <p style="color: #666; font-size: 14px; margin: 0 0 24px 0;">Accédez à votre espace</p>
                    <form @submit.prevent="login()" style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 500; color: #333; margin-bottom: 4px;">Code d'accès</label>
                            <input type="text" x-model="loginCode" @keyup.enter="login()" placeholder="ABC123" class="win-input" required autofocus />
                        </div>
                        <button type="submit" class="win-button-primary" style="width: 100%;" :disabled="isLoading">
                            <span x-show="!isLoading">Se connecter</span>
                            <span x-show="isLoading">Connexion...</span>
                        </button>
                    </form>
                    <div x-show="message.text" style="font-size: 13px; padding: 12px; border-radius: 2px; margin-top: 12px;" :class="`${message.type === 'error' ? 'background: #fee; border: 1px solid #f88; color: #c33;' : 'background: #efe; border: 1px solid #8f8; color: #3c3;'}`" x-text="message.text"></div>
                </div>
            </div>

            <div x-show="school" style="flex: 1; overflow-y: auto;">
                <div style="padding: 24px; display: flex; flex-direction: column; gap: 24px;">
                    <!-- Statistiques -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; padding: 16px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 13px; font-weight: 500; color: #666;">Limite</p>
                            <p style="margin: 8px 0 0 0; font-size: 32px; font-weight: bold; color: #0078d4;" x-text="school.student_limit"></p>
                        </div>
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #81c784; padding: 16px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 13px; font-weight: 500; color: #666;">Enregistrés</p>
                            <p style="margin: 8px 0 0 0; font-size: 32px; font-weight: bold; color: #388e3c;" x-text="students.length"></p>
                        </div>
                        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 1px solid #ffb74d; padding: 16px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 13px; font-weight: 500; color: #666;">Restants</p>
                            <p style="margin: 8px 0 0 0; font-size: 32px; font-weight: bold; color: #f57f17;" x-text="school.student_limit - students.length"></p>
                        </div>
                    </div>

                    <!-- Formulaire -->
                    <div style="background: #f5f5f5; border: 1px solid #d0d0d0; padding: 16px; border-radius: 4px;">
                        <h3 style="margin: 0 0 12px 0; font-weight: bold; font-size: 16px; color: #333;" x-text="editingStudent ? 'Modifier un élève' : 'Ajouter un nouvel élève'"></h3>
                        <form @submit.prevent="saveStudent()" style="display: grid; gap: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <input type="text" x-model="newStudent.last_name" placeholder="Nom" required class="win-input" />
                                <input type="text" x-model="newStudent.first_name" placeholder="Prénom" required class="win-input" />
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <select x-model="newStudent.sex" class="win-input">
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                </select>
                                <input type="date" x-model="newStudent.birth_date" class="win-input" />
                                <select x-model="newStudent.birth_place" class="win-input">
                                    <option value="">-- Sélectionner --</option>
                                    <option value="Bouenza">Bouenza</option>
                                    <option value="Brazzaville">Brazzaville</option>
                                    <option value="Congo-Oubangui">Congo-Oubangui</option>
                                    <option value="Cuvette">Cuvette</option>
                                    <option value="Cuvette-Ouest">Cuvette-Ouest</option>
                                    <option value="Djoué-Léfini">Djoué-Léfini</option>
                                    <option value="Kouilou">Kouilou</option>
                                    <option value="Lékoumou">Lékoumou</option>
                                    <option value="Likouala">Likouala</option>
                                    <option value="Niari">Niari</option>
                                    <option value="Nkéni-Alima">Nkéni-Alima</option>
                                    <option value="Plateaux">Plateaux</option>
                                    <option value="Pointe-Noire">Pointe-Noire</option>
                                    <option value="Pool">Pool</option>
                                    <option value="Sangha">Sangha</option>
                                </select>
                            </div>
                            <button type="submit" class="win-button-primary" :disabled="isLoading || (school && students.length >= school.student_limit && !editingStudent)">
                                <span x-show="!isLoading" x-text="editingStudent ? '↪ MAJ' : '➕ Ajouter'"></span>
                                <span x-show="isLoading">...</span>
                            </button>
                            <template x-if="editingStudent">
                                <button type="button" @click="cancelEdit()" class="win-button" style="font-size: 12px;">✕ Annuler modification</button>
                            </template>
                        </form>
                    </div>

                    <!-- Tableau -->
                    <div style="background: white; border: 1px solid #d0d0d0; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="border-bottom: 1px solid #d0d0d0; padding: 12px 16px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-weight: bold; font-size: 14px;">Élèves (<span x-text="students.length"></span>)</h3>
                            <div style="display: flex; gap: 8px;">
                                <button @click="showFilters = !showFilters" class="win-button" style="font-size: 12px; padding: 6px 12px; background: #0078d4; color: white; border: 1px solid #005a9e;">
                                    <span x-text="showFilters ? '🔍 Fermer' : '⚙️ Filtres'"></span>
                                </button>
                                <button @click="exportToExcel()" class="win-button" style="font-size: 12px; padding: 6px 12px;" :disabled="students.length === 0">📊 Excel</button>
                            </div>
                        </div>

                        <div x-show="showFilters" x-transition style="border-bottom: 1px solid #d0d0d0; background: #e3f2fd; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                            <input type="text" x-model="searchText" placeholder="Rechercher par nom ou prénom..." class="win-input" />
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <select x-model="filterSex" class="win-input">
                                    <option value="">Tous les sexes</option>
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                </select>
                                <select x-model="sortBy" class="win-input">
                                    <option value="nom">Nom ↑</option>
                                    <option value="nom-desc">Nom ↓</option>
                                    <option value="date">Récent</option>
                                </select>
                                <button @click="resetFilters()" class="win-button" style="color: #0078d4;">↻ Réinitialiser</button>
                            </div>
                        </div>

                        <div style="overflow-x: auto; flex: 1;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f0f0f0; border-bottom: 1px solid #d0d0d0;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">#</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Nom</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Prénom</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Sexe</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Date de naissance</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Lieu de naissance</th>
                                        <th style="padding: 12px; text-align: left; font-weight: bold; font-size: 13px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(student, index) in filteredStudents" :key="student.id">
                                        <tr style="border-bottom: 1px solid #e0e0e0; hover: background: #f9f9f9;">
                                            <td style="padding: 12px; font-size: 13px;" x-text="index + 1"></td>
                                            <td style="padding: 12px; font-size: 13px; font-weight: 500;" x-text="student.last_name"></td>
                                            <td style="padding: 12px; font-size: 13px;" x-text="student.first_name"></td>
                                            <td style="padding: 12px; font-size: 13px;" x-text="student.sex === 'M' ? '👨 M' : '👩 F'"></td>
                                            <td style="padding: 12px; font-size: 13px;" x-text="formatDate(student.birth_date)"></td>
                                            <td style="padding: 12px; font-size: 13px;" x-text="student.birth_place"></td>
                                            <td style="padding: 12px; display: flex; gap: 4px;">
                                                <button @click="editStudent(student)" class="win-button" style="font-size: 12px; padding: 4px 8px;">✏️</button>
                                                <button @click="deleteStudent(student.id)" class="win-button" style="font-size: 12px; padding: 4px 8px; color: #c50f1f;">🗑️</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <template x-if="students.length === 0">
                            <div style="padding: 32px; text-align: center; color: #999; font-size: 14px;">Aucun élève</div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showEditModal" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div style="background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 500px; width: 100%;" @click.away="showEditModal = false">
            <div style="background: linear-gradient(to right, #4caf50, #45a049); padding: 16px; display: flex; justify-content: space-between; align-items: center; color: white; border-radius: 8px 8px 0 0;">
                <h2 style="margin: 0; font-weight: bold; font-size: 18px;">✏️ Modifier l'élève</h2>
                <button @click="showEditModal = false" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px;">✕</button>
            </div>
            <form @submit.prevent="saveStudent()" style="padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px;">Nom</label>
                        <input type="text" x-model="newStudent.last_name" placeholder="Nom" required class="win-input" autofocus />
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px;">Prénom</label>
                        <input type="text" x-model="newStudent.first_name" placeholder="Prénom" required class="win-input" />
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px;">Sexe</label>
                        <select x-model="newStudent.sex" class="win-input">
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px;">Date de naissance</label>
                        <input type="date" x-model="newStudent.birth_date" class="win-input" />
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px;">Lieu</label>
                        <select x-model="newStudent.birth_place" class="win-input">
                            <option value="">-- Sélectionner --</option>
                            <option value="Bouenza">Bouenza</option>
                            <option value="Brazzaville">Brazzaville</option>
                            <option value="Congo-Oubangui">Congo-Oubangui</option>
                            <option value="Cuvette">Cuvette</option>
                            <option value="Cuvette-Ouest">Cuvette-Ouest</option>
                            <option value="Djoué-Léfini">Djoué-Léfini</option>
                            <option value="Kouilou">Kouilou</option>
                            <option value="Lékoumou">Lékoumou</option>
                            <option value="Likouala">Likouala</option>
                            <option value="Niari">Niari</option>
                            <option value="Nkéni-Alima">Nkéni-Alima</option>
                            <option value="Plateaux">Plateaux</option>
                            <option value="Pointe-Noire">Pointe-Noire</option>
                            <option value="Pool">Pool</option>
                            <option value="Sangha">Sangha</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; padding-top: 12px;">
                    <button type="button" @click="showEditModal = false" class="win-button" style="flex: 1; font-weight: bold;">✕ Annuler</button>
                    <button type="submit" class="win-button-primary" style="flex: 1; font-weight: bold;" :disabled="isLoading">
                        <span x-show="!isLoading">✓ Sauvegarder</span>
                        <span x-show="isLoading">⏳ Sauvegarde...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = "https://kgeerjuindhoueyzfemk.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnZWVyanVpbmRob3VleXpmZW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzUyNTIsImV4cCI6MjA3NzAxMTI1Mn0.VOkXxOPL53o49FGZTQ1jP9jm_9rXhu30toRac-codjs";
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        const DB_NAME = "SchoolPortalDB";
        const STORE_NAME = "students";

        function schoolApp() {
            return {
                loginCode: "",
                school: null,
                students: [],
                newStudent: { 
                    first_name: "", 
                    last_name: "", 
                    sex: "M",
                    birth_date: "",
                    birth_place: ""
                },
                editingStudent: null,
                isLoading: false,
                isSyncing: false,
                message: { text: "", type: "info" },
                isMinimized: false,
                isMaximized: false,
                db: null,
                isOnline: navigator.onLine,
                isDragging: false,
                dragStart: { x: 0, y: 0 },
                windowStart: { x: 0, y: 0 },
                searchText: "",
                filterSex: "",
                sortBy: "nom",
                showFilters: false,
                showEditModal: false,

                async initApp() {
                    console.log("Initialisation...");
                    await this.initIndexedDB();
                    this.checkOnlineStatus();
                    window.addEventListener('online', () => this.handleOnline());
                    window.addEventListener('offline', () => this.handleOffline());
                    if (window.innerWidth > 1024) {
                        document.addEventListener('mousemove', (e) => this.handleDrag(e));
                        document.addEventListener('mouseup', () => this.stopDrag());
                    }
                    await this.restoreSession();
                    const urlParams = new URLSearchParams(window.location.search);
                    const codeFromUrl = urlParams.get("code");
                    if (codeFromUrl) {
                        this.loginCode = codeFromUrl.toUpperCase();
                        await this.login();
                    }
                    setInterval(() => this.autoSync(), 30000);
                },

                startDrag(e) {
                    if (window.innerWidth <= 1024) return;
                    this.isDragging = true;
                    this.dragStart = { x: e.clientX, y: e.clientY };
                    const container = document.querySelector('.app-container');
                    const rect = container.getBoundingClientRect();
                    this.windowStart = { x: rect.left, y: rect.top };
                },

                handleDrag(e) {
                    if (!this.isDragging || window.innerWidth <= 1024) return;
                    const dx = e.clientX - this.dragStart.x;
                    const dy = e.clientY - this.dragStart.y;
                    const container = document.querySelector('.app-container');
                    container.style.position = 'fixed';
                    container.style.left = (this.windowStart.x + dx) + 'px';
                    container.style.top = (this.windowStart.y + dy) + 'px';
                    container.style.margin = '0';
                    container.style.zIndex = '1000';
                },

                stopDrag() {
                    this.isDragging = false;
                },

                checkOnlineStatus() {
                    this.isOnline = navigator.onLine;
                },

                handleOnline() {
                    this.isOnline = true;
                    this.showMessage("✅ En ligne - Synchronisation...", "success");
                    if (this.school) this.syncStudents();
                },

                handleOffline() {
                    this.isOnline = false;
                    this.showMessage("⚠️ Hors ligne", "warning");
                },

                saveSession() {
                    if (this.school) {
                        const session = {
                            school: {
                                id: this.school.id,
                                name: this.school.name,
                                access_code: this.school.access_code,
                                matricule: this.school.matricule,
                                student_limit: this.school.student_limit,
                                phone_number: this.school.phone_number,
                                address: this.school.address,
                                is_active: this.school.is_active
                            },
                            timestamp: Date.now()
                        };
                        localStorage.setItem("schoolSession", JSON.stringify(session));
                    }
                },

                async restoreSession() {
                    const sessionData = localStorage.getItem("schoolSession");
                    if (sessionData) {
                        try {
                            const session = JSON.parse(sessionData);
                            const sessionAge = Date.now() - session.timestamp;
                            const maxSessionAge = 24 * 60 * 60 * 1000;
                            if (sessionAge < maxSessionAge) {
                                this.school = session.school;
                                this.students = await this.getFromLocal();
                                if (this.isOnline) {
                                    await this.syncStudents();
                                } else {
                                    this.showMessage(`${this.students.length} élèves (local)`, "info");
                                }
                            } else {
                                localStorage.removeItem("schoolSession");
                            }
                        } catch (err) {
                            localStorage.removeItem("schoolSession");
                        }
                    }
                },

                async initIndexedDB() {
                    return new Promise((resolve) => {
                        const request = indexedDB.open(DB_NAME, 1);
                        request.onsuccess = () => {
                            this.db = request.result;
                            resolve();
                        };
                        request.onupgradeneeded = (e) => {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains(STORE_NAME)) {
                                db.createObjectStore(STORE_NAME, { keyPath: "id" });
                            }
                        };
                    });
                },

                async saveToLocal(data) {
                    return new Promise((resolve) => {
                        const transaction = this.db.transaction([STORE_NAME], "readwrite");
                        const store = transaction.objectStore(STORE_NAME);
                        store.clear();
                        if (Array.isArray(data)) {
                            data.forEach(s => store.add(JSON.parse(JSON.stringify(s))));
                        }
                        transaction.oncomplete = () => resolve();
                    });
                },

                async getFromLocal() {
                    return new Promise((resolve) => {
                        const transaction = this.db.transaction([STORE_NAME], "readonly");
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                    });
                },

                async login() {
                    this.isLoading = true;
                    this.message = { text: "", type: "info" };
                    try {
                        if (!this.isOnline) throw new Error("Pas de connexion");
                        const { data, error } = await supabaseClient
                            .from("schools")
                            .select("*")
                            .eq("access_code", this.loginCode.toUpperCase())
                            .single();
                        if (error || !data) throw new Error("Code invalide");
                        if (!data.is_active) throw new Error("Compte inactif");
                        this.school = data;
                        this.saveSession();
                        await this.syncStudents();
                        this.showMessage("✅ Connecté!", "success");
                    } catch (err) {
                        this.showMessage("❌ " + err.message, "error");
                    }
                    this.isLoading = false;
                },

                async syncStudents() {
                    this.isSyncing = true;
                    try {
                        if (!this.isOnline) {
                            this.students = await this.getFromLocal();
                            this.isSyncing = false;
                            return;
                        }
                        const { data, error } = await supabaseClient
                            .from("students")
                            .select("*")
                            .eq("school_id", this.school.id)
                            .order("last_name");
                        if (error) throw error;
                        this.students = (data || []).map(s => ({ ...s }));
                        await this.saveToLocal(this.students);
                    } catch (err) {
                        this.students = await this.getFromLocal();
                    }
                    this.isSyncing = false;
                },

                async autoSync() {
                    if (this.school && this.isOnline) await this.syncStudents();
                },

                async saveStudent() {
                    if (this.students.length >= this.school.student_limit && !this.editingStudent) {
                        this.showMessage("Limite atteinte", "error");
                        return;
                    }
                    this.isLoading = true;
                    try {
                        if (!this.isOnline) {
                            if (this.editingStudent) {
                                const i = this.students.findIndex(s => s.id === this.editingStudent.id);
                                if (i > -1) this.students[i] = { ...this.newStudent };
                            } else {
                                this.students.push({ ...this.newStudent, id: 'temp_' + Date.now(), school_id: this.school.id });
                            }
                            await this.saveToLocal(this.students);
                            this.showMessage(this.editingStudent ? "✏️ Modifié (local)" : "➕ Ajouté (local)", "success");
                            this.resetForm();
                            return;
                        }

                        if (this.editingStudent) {
                            const { error } = await supabaseClient
                                .from("students")
                                .update(this.newStudent)
                                .eq("id", this.editingStudent.id);
                            if (error) throw error;
                            this.showMessage("✏️ Modifié!", "success");
                        } else {
                            const { error } = await supabaseClient
                                .from("students")
                                .insert([{ ...this.newStudent, school_id: this.school.id }]);
                            if (error) throw error;
                            this.showMessage("➕ Ajouté!", "success");
                        }
                        this.resetForm();
                        await this.syncStudents();
                    } catch (err) {
                        this.showMessage("❌ " + err.message, "error");
                    }
                    this.isLoading = false;
                    this.showEditModal = false;
                },

                editStudent(student) {
                    this.editingStudent = student;
                    this.newStudent = { ...student };
                    this.showEditModal = true;
                },

                cancelEdit() {
                    this.resetForm();
                    this.showEditModal = false;
                },

                async deleteStudent(studentId) {
                    if (!confirm("Supprimer?")) return;
                    try {
                        if (!this.isOnline || studentId.startsWith('temp_')) {
                            this.students = this.students.filter(s => s.id !== studentId);
                            await this.saveToLocal(this.students);
                            this.showMessage("🗑️ Supprimé (local)", "success");
                            return;
                        }
                        const { error } = await supabaseClient
                            .from("students")
                            .delete()
                            .eq("id", studentId);
                        if (error) throw error;
                        this.showMessage("🗑️ Supprimé!", "success");
                        await this.syncStudents();
                    } catch (err) {
                        this.showMessage("❌ " + err.message, "error");
                    }
                },

                exportToExcel() {
                    // Entête avec info école
                    const ws_data = [
                        ["RAPPORT D'EFFECTIF SCOLAIRE"],
                        [],
                        ["Nom de l'école:", this.school.name],
                        ["Code d'accès:", this.school.access_code],
                        ["Matricule:", this.school.matricule],
                        ["Effectif total:", this.students.length],
                        ["Limite:", this.school.student_limit],
                        ["Date d'export:", new Date().toLocaleDateString('fr-FR')],
                        [],
                        ["N°", "Nom", "Prénom", "Sexe", "Date de naissance", "Lieu de naissance"]
                    ];

                    // Données des élèves
                    this.students.forEach((s, i) => {
                        ws_data.push([
                            i + 1, 
                            s.last_name, 
                            s.first_name, 
                            s.sex === 'M' ? 'M' : 'F',
                            this.formatDate(s.birth_date),
                            s.birth_place || ''
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(ws_data);
                    ws['!cols'] = [
                        { wch: 5 },
                        { wch: 20 },
                        { wch: 20 },
                        { wch: 8 },
                        { wch: 18 },
                        { wch: 18 }
                    ];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Élèves");
                    XLSX.writeFile(wb, `Effectif_${this.school.name}_${new Date().toISOString().split("T")[0]}.xlsx`);
                    this.showMessage("📊 Exporté avec succès!", "success");
                },

                resetForm() {
                    this.newStudent = { 
                        first_name: "", 
                        last_name: "", 
                        sex: "M",
                        birth_date: "",
                        birth_place: ""
                    };
                    this.editingStudent = null;
                },

                showMessage(text, type) {
                    this.message = { text, type };
                    setTimeout(() => { this.message = { text: "", type: "info" }; }, 3000);
                },

                logout() {
                    if (confirm("Déconnexion?")) {
                        this.school = null;
                        this.students = [];
                        this.loginCode = "";
                        localStorage.removeItem("schoolSession");
                        window.history.pushState({}, document.title, window.location.pathname);
                        this.showMessage("✅ Déconnecté", "success");
                    }
                },

                resetFilters() {
                    this.searchText = "";
                    this.filterSex = "";
                    this.sortBy = "nom";
                },

                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('fr-FR');
                },

                get filteredStudents() {
                    let filtered = this.students;

                    if (this.searchText.trim()) {
                        const search = this.searchText.toLowerCase();
                        filtered = filtered.filter(s => 
                            s.last_name.toLowerCase().includes(search) ||
                            s.first_name.toLowerCase().includes(search)
                        );
                    }

                    if (this.filterSex) {
                        filtered = filtered.filter(s => s.sex === this.filterSex);
                    }

                    filtered.sort((a, b) => {
                        if (this.sortBy === "nom") {
                            return a.last_name.localeCompare(b.last_name);
                        } else if (this.sortBy === "nom-desc") {
                            return b.last_name.localeCompare(a.last_name);
                        } else if (this.sortBy === "date") {
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                        }
                        return 0;
                    });

                    return filtered;
                }
            };
        }
    </script>
